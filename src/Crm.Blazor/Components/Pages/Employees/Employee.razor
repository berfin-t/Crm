@page "/employees"

@using Blazorise.Components
@using Crm.Employees
@using Crm.Common
@using Crm.Blazor.Components
@using Crm.Positions

@inject NavigationManager Navigation
@inject IEmployeeAppService EmployeeAppService
@inject IPositionAppService PositionAppService
@inject Microsoft.Extensions.Localization.IStringLocalizer<Crm.Localization.CrmResource> L
@inject IAuthorizationService AuthorizationService

<Div Margin="Margin.IsAuto.OnX">
    <Card>
        <CardBody Flex="Flex.JustifyContent.Between.AlignItems.Center">
            <Div>
                <Field Display="Display.InlineFlex" Margin="Margin.Is0.FromBottom">
                    <Autocomplete TItem="EmployeeDto"
                        TValue="string"
                        Data="@ReadDataEmployees"
                        TextField="@getName"
                        ValueField="getId"
                        ReadData="@OnHandleReadData"
                        @bind-SelectedText="selectedAutoCompleteText"
                        @onkeydown="OnEntered"
                        Placeholder="@L["Search"]"
                        FreeTyping>
                    </Autocomplete>                   
                </Field>
            </Div>
            @if (canCreateEmployee)
            {
                <Div Flex="Flex.JustifyContent.Between.AlignItems.Center" Gap="Gap.Is3">
                    <Field Display="Display.InlineFlex" Margin="Margin.Is0.FromBottom">
                    <Button Color="Color.Success" Clicked="@ShowCreateModal">@L["Add Employee"]</Button>
                </Field>               
            </Div>
            }
        </CardBody>
    </Card>
</Div>

<Row>
    @foreach (var employee in FilteredEmployees)
    {
        <Column ColumnSize="ColumnSize.Is4.OnWidescreen.Is8.OnDesktop.Is10.OnTablet">
            <Card>
                <CardBody>
                    <Div style="position: relative; padding-top: 10px;">

                        <!-- Dropdown Toggle Button (Sağ Üstte) -->
                        @if (canEditEmployee || canDeleteEmployee)
                        {
                            <Div style="position: absolute; top: 10px; right: 10px;">
                                <Dropdown>
                                    <DropdownToggle>
                                        <span class="menu-icon">⋮</span>
                                    </DropdownToggle>

                                    <DropdownMenu>
                                        @if (canEditEmployee)
                                        {
                                            <DropdownItem @onclick="() => OnSelectEmployeeForEdit(employee)">
                                                @L["Edit"]
                                            </DropdownItem>
                                        }

                                        @if (canDeleteEmployee)
                                        {
                                            <DropdownItem TextColor="TextColor.Danger"
                                                          @onclick="() => OnSelectEmployeeForDelete(employee)">
                                                @L["Delete"]
                                            </DropdownItem>
                                        }
                                    </DropdownMenu>
                                </Dropdown>
                            </Div>
                        }

                        <Div style="display: flex; flex-direction: column; align-items: center; text-align: center; margin-top: 40px;">
                            <img src="@employee.PhotoPath" alt="Profile Photo" 
                                 style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;" />
                            <Span style="font-weight: bold; font-size: 16px; color: black;">@employee.FullName</Span>
                            <Span style="font-size: 14px; color: gray;">
                                @PositionList.FirstOrDefault(p => p.Id == employee.PositionId)?.Name
                            </Span>
                            <a href="mailto:@employee.Email" style="font-size: 14px; color: blue; text-decoration: none; margin-top: 5px;">
                                @employee.Email
                            </a>
                            <Span style="font-size: 14px; color: black; margin-top: 5px;">
                                @employee.PhoneNumber
                            </Span>
                        </Div>

                    </Div>
                </CardBody>
            </Card>
        </Column>
    }
</Row>

<Div Flex="Flex.JustifyContent.Center">
    <Button Color="Color.Light" @onclick="LoadMoreEmployees">@L["Load More"]</Button>
</Div>

@* DELETE MODAL *@
<Modal @bind-Visible="isDeleteModalVisible" Size="ModalSize.Small" BackdropClick="true">
    <ModalContent>
        <ModalHeader>
            <ModalTitle>@L["Confirm"]</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            @L["Are you sure you want to delete"]?
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Danger" @onclick="ConfirmDelete">@L["Delete"]</Button>
            <Button Color="Color.Secondary" @onclick="() => isDeleteModalVisible = false">@L["Close"]</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

@* CREATE MODAL *@
<Crm.Blazor.Components.Dialogs.Employees.EmployeeCreateModal @ref="employeeCreateModal" />

@* EDIT MODAL *@
<Crm.Blazor.Components.Dialogs.Employees.EmployeeEditModal @ref="employeeEditModal" />