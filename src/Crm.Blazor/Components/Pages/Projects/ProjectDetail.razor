@page "/project-detail/{ProjectId:guid}"

@using Crm.Employees
@using Crm.Customers
@using Crm.Projects
@using Crm.Common
@using Blazorise.Icons.FontAwesome
@using System.ComponentModel.DataAnnotations
@using Crm.Tasks

@inject IProjectAppService ProjectAppService
@inject ITaskAppService TaskAppService
@inject IEmployeeAppService EmployeeAppService
@inject NavigationManager NavigationManager
@inject IAuthorizationService AuthorizationService
@inject Microsoft.Extensions.Localization.IStringLocalizer<Crm.Localization.CrmResource> L

@if (project != null)
{
    <Card>
        <CardBody>
            <Div class="project-overview">
                <Div class="overview-item">
                    <Blazorise.Icons.FontAwesome.Icon Name="IconName.Users" Class="icon" />
                    <Div>
                        <Div class="top-label">@L["Total Tasks"]</Div>
                        <Div class="field-label">@totalTasks</Div>
                    </Div>
                </Div>
                <Div class="overview-item">
                    <Blazorise.Icons.FontAwesome.Icon Name="IconName.Users" Class="icon" />
                    <Div>
                        <Div class="top-label">@L["Tasks Completed"]</Div>
                        <Div class="field-label">@completedTasks</Div>
                    </Div>
                </Div>
                <Div class="overview-item">
                    <Blazorise.Icons.FontAwesome.Icon Name="IconName.Users" Class="icon" />
                    <Div>
                        <Div class="top-label">@L["Team Size"]</Div>
                        <Div class="field-label">@teamSize</Div>
                    </Div>
                </Div>                
            </Div>
        </CardBody>
    </Card>

    <Card>
        <CardBody>
            <CardTitle Size="5">
                <Div class="project-header">
                    <h4 class="project-title">
                        @project.Name
                        <span class="status-label status-@project.Status.ToString().ToLower()">
                            @project.Status
                        </span>
                    </h4>
                    @if(canEditProject || canDeleteProject) {
                    <Dropdown>
                        <DropdownToggle>
                            <span class="menu-icon">⋮</span>
                        </DropdownToggle>
                        <DropdownMenu>                           
                                <DropdownItem @onclick="() => OnSelectProjectForEdit(project)">@L["Edit"]</DropdownItem>                            
                                <DropdownItem @onclick="() => isDeleteModalVisible = true">@L["Delete"]</DropdownItem>                            
                        </DropdownMenu>
                    </Dropdown>
                    }                    
                </Div>
            </CardTitle>

            <p class="project-description">@project.Description</p>

            <Div class="project-dates">
                <Div>
                    <strong>@L["Start Date"]</strong>
                    <p>@(project.StartTime?.ToString("dd MMMM yyyy h:mm tt") ?? "-")</p>
                </Div>
                <Div>
                    <strong>@L["End Date"]</strong>
                    <p>@(project.EndTime?.ToString("dd MMMM yyyy h:mm tt") ?? "-")</p>
                </Div>
            </Div>

            <Div Flex="Flex.JustifyContent.Between.AlignItems.Center" Gap="Gap.Is3">
                <Div class="team-members">
                    <strong>@L["Team Members"]:</strong>

                    @if (projectEmployees != null && projectEmployees.Any())
                    {
                        <Div class="member-avatars">
                            @foreach (var emp in projectEmployees)
                            {
                                <Div class="member-avatar" title="@emp.EmployeeName">
                                    <img src="@emp.PhotoPath" />
                                </Div>
                            }
                        </Div>
                    }
                    else
                    {
                        <p>@L["No team members assigned"].</p>
                    }
                </Div>
                <Field Display="Display.InlineFlex" Margin="Margin.Is0.FromBottom">
                    <Button Color="Color.Success" Style="width: 125px;" Clicked="@ShowAddEmployeeModal">
                        @L["Add Employee"]
                    </Button>
                </Field>
            </Div>
            

        </CardBody>
    </Card>

    <Card>
    <CardBody>
        <CardTitle Size="5">@L["Project Tasks"]</CardTitle>

        @if (projectTasks != null && projectTasks.Any())
        {
            <Table Striped Hoverable FullWidth>
                <thead>
                    <tr>
                        <th>@L["Project Name"]</th>
                        <th>@L["Description"]</th>
                        <th>@L["Status"]</th>
                        <th>@L["Priority"]</th>
                        <th>@L["Due Date"]</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var task in projectTasks)
                    {
                        <tr>
                            <td>@task.Name</td>
                            <td>@task.Description</td>
                            <td>
                            @{
                                var status = task.Status;
                                var badgeClass = status switch
                                {
                                    EnumStatus.Active => "badge bg-primary",          
                                    EnumStatus.Pending => "badge bg-warning text-dark", 
                                    EnumStatus.Completed => "badge bg-success",       
                                    EnumStatus.Canceled => "badge bg-danger",         
                                    _ => "badge bg-light text-dark"
                                };
                            }
                            <span class="@badgeClass">@status</span>
                            </td>
                                <td>
                                    @{
                                        var priority = task.Priority;
                                        var priorityBadgeClass = priority switch
                                        {
                                            EnumPriority.Low => "badge bg-secondary",
                                            EnumPriority.Medium => "badge bg-info",
                                            EnumPriority.High => "badge bg-warning text-dark",
                                            EnumPriority.Critical => "badge bg-danger",
                                            _ => "badge bg-light text-dark"
                                        };
                                    }

                                    <span class="@priorityBadgeClass">@priority</span>
                                </td>                            
                            <td>@task.DueDate.ToString("dd MMM yyyy HH:mm")</td>
                        </tr>
                    }
                </tbody>
            </Table>
        }
        else
        {
            <p>@L["No tasks found for this project"]</p>
        }
    </CardBody>
</Card>

}
else
{
    <p>@L["Loading project details"]...</p>
}

@* ********** PROJECT DELETE MODAl ********** *@
<Modal @bind-Visible="isDeleteModalVisible" Size="ModalSize.Small" BackdropClick="true">
    <ModalContent>
        <ModalHeader>
            <ModalTitle>@L["Confirm"]</ModalTitle>
            <Button CloseButton @onclick="() => isDeleteModalVisible = false" />
        </ModalHeader>
        <ModalBody>
            @L["Are you sure you want to delete"]?
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Danger" @onclick="ConfirmDelete">@L["Delete"]</Button>
            <Button Color="Color.Secondary" @onclick="() => isDeleteModalVisible = false">@L["Close"]</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

@* ********** EDIT MODAL ********** *@
<Crm.Blazor.Components.Dialogs.Projects.ProjectEditModal @ref="projectEditModal" />

@* ********** ADD EMPLOYEE MODAL ********** *@
<Modal @bind-Visible="isActivityModalVisible" Size="ModalSize.Medium"> 
    <ModalContent>

        <ModalHeader>
            <ModalTitle>Add Employee</ModalTitle>
            <CloseButton/>
        </ModalHeader>

        <ModalBody>
            <Div class="team-members mb-3">
                <strong>@L["Team Members"]:</strong>

                @if (projectEmployees != null && projectEmployees.Any())
                {
                    <Div class="member-avatars">
                        @foreach (var emp in projectEmployees)
                        {
                            <Div class="member-avatar" title="@emp.EmployeeName">
                                <img src="@emp.PhotoPath" />
                            </Div>
                        }
                    </Div>
                }
                else
                {
                    <p>@L["No team members assigned"].</p>
                }
            </Div>

            <!-- Employee -->
            <Div class="mt-3">
                <Field>
                    <FieldLabel>@L["Employees"]:</FieldLabel>
                    <FieldBody>
                        <Select TValue="Guid"
                                Multiple="true"
                                SelectedValues="SelectedEmployeeIds"
                                SelectedValuesChanged="@(v => SelectedEmployeeIds = v.ToList())">
                            @foreach (var employee in FilteredEmployees)
                            {
                                <SelectItem Value="@employee.Id">@employee.FirstName @employee.LastName</SelectItem>
                            }
                        </Select>
                    </FieldBody>
                </Field>
            </Div>            
        </ModalBody>

        <ModalFooter>
            <Button Color="Color.Primary" @onclick="UpdateProjectTeam">@L["Add Employee"]</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<style>
    .status-label {
        color: white;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: bold;
    }

    .status-pending {
        background-color: #e8f5e9;
        color: orange;
    }

    .status-active {
        background-color: #e8f5e9;
        color: dodgerblue;
    }

    .status-canceled {
        background-color: #e8f5e9;
        color: red;
    }

    .status-completed {
        background-color: #e8f5e9;
        color: #28a745;
    }

    .project-overview {
        display: flex;
        justify-content: space-between;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        margin-top: 20px;
        font-size: 14px;
        color: #666;
        margin-bottom: 15px;
    }

    .overview-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .overview-item .icon {
            font-size: 24px;
            color: #6c757d;
        }

    .top-label {
        font-size: 14px;
        color: #6c757d;
        margin-bottom: 5px;
    }

    .field-label {
        font-size: 18px;
        color: #000;
        font-weight: 500;
    }

    .project-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .project-title {
        color: #000000;
        font-size: 20px;
    }

    .menu-icon {
        cursor: pointer;
        font-size: 20px;
    }

    .project-dates {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }

        .project-dates div {
            text-align: center;
        }

    .team-members {
        margin-top: 15px;
    }

    .member-avatars {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .member-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%; 
        overflow: hidden; 
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        cursor: default;
    }

        .member-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

    .project-description {
        font-size: 14px;
        color: #666;
        margin-bottom: 15px;
    }

</style>
