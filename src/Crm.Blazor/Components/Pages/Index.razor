@page "/"
@attribute [Authorize]
@using Crm.Permissions
@using Volo.Abp.MultiTenancy
@using Crm.Projects
@using Crm.Tasks
@using Crm.Customers
@using Crm.Common
@using Crm.Employees

@inherits CrmComponentBase

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IProjectAppService ProjectAppService
@inject ITaskAppService TasksAppService
@inject ICustomerAppService CustomersAppService
@inject IEmployeeAppService EmployeeAppService
@inject IAuthorizationService AuthorizationService

<Div class="card-container">
    <Card class="left-card">        
    <CardBody>
        <Div class="project-overview">
            <Div class="overview-item">
                <Blazorise.Icons.FontAwesome.Icon Name="IconName.CheckSquare" Class="icon" />
                <Div>
                    <Div class="top-label">@L["Total Projects"]</Div>
                    <Div class="field-label">@totalProjects</Div>
                </Div>
            </Div>
            <Div class="overview-item">
                <Blazorise.Icons.FontAwesome.Icon Name="IconName.Check" Class="icon" />
                <Div>
                    <Div class="top-label">@L["Total Tasks"]</Div>
                    <Div class="field-label">@totalTasks</Div>
                </Div>
            </Div>
                @if (CanViewCustomers)
                {
                    <Div class="overview-item">
                        <Blazorise.Icons.FontAwesome.Icon Name="IconName.Users" Class="icon" />
                        <Div>
                            <Div class="top-label">@L["Total Customer"]</Div>
                            <Div class="field-label">@totalCustomer</Div>
                        </Div>
                    </Div>
                }
        </Div>
    </CardBody>
    
</Card>

    <Card class="right-card">
    <CardBody>
            <Span class="welcome-mesaage">
                @L["WelcomeMessage", GetCurrentUserFullName()]
            </Span>
    </CardBody>
</Card>
</Div>

<Card class="mt-4">
    <CardBody>
        <Div class="progress-info">
            <Div class="top-label">@L["Project Success Rate"]</Div>
            <Progress Class="my-2" Max="100" Value="@(Convert.ToInt32(totalSuccessRate))" Color="Color.Success" />
            <Div class="field-label">@($"{totalSuccessRate}%")</Div>
        </Div>
    </CardBody>
</Card>

<div class="row">
    <div class="col-md-6">
        <Card class="mt-4">
            <CardBody>
                <Div class="overview-item">
                    <Blazorise.Icons.FontAwesome.Icon Name="IconName.UserPlus" Class="icon" />
                    <Div>
                        <Div class="top-label">@L["This Month's New Customers"]</Div>
                        <Div class="field-label">@newCustomersThisMonth</Div>
                    </Div>
                </Div>
            </CardBody>
        </Card>
    </div>

    <div class="col-md-6">
        <Card class="mt-4">
            <CardBody>
                <Div class="overview-item">
                    <Blazorise.Icons.FontAwesome.Icon Name="IconName.Star" Class="icon" />
                    <Div>
                        <Div class="top-label">@L["Active Tasks"]</Div>
                        <Div class="field-label">@activeTasks</Div>
                    </Div>
                </Div>
            </CardBody>
        </Card>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <Card>
            <CardBody>
                <Div class="top-label mb-2">
                    📅 Number of Tasks Assigned This Month (Employee Based)
                </Div>

                <div class="table-responsive scroll-table">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Employee</th>
                                <th class="text-end">Task</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (employeeMonthlyTasks.Any())
                            {
                                @foreach (var item in employeeMonthlyTasks)
                                {
                                    <tr>
                                        <td>@item.EmployeeName</td>
                                        <td class="text-end">@item.TaskCount</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="2" class="text-center text-muted">
                                        No data found
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </CardBody>
        </Card>
    </div>
</div>



@code {
    
    private long totalProjects;
    private long totalTasks;
    private long totalCustomer;
    private decimal totalSuccessRate;  
    private decimal? successRate = null;
    private bool CanViewCustomers;    
    private List<EmployeeMonthlyTaskCountDto> employeeMonthlyTasks = new();

    protected override async System.Threading.Tasks.Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        // ABP izin kontrolü
        var isAdmin = user.IsInRole("Admin");
        var canViewCustomersResult = await AuthorizationService.AuthorizeAsync(user, CrmPermissions.Customers.Default);
        CanViewCustomers = isAdmin || canViewCustomersResult.Succeeded;

        // Dashboard verileri
        totalProjects = await ProjectAppService.GetTotalProjectCountAsync();
        totalTasks = await TasksAppService.GetTotalTaskCountAsync();

        if (CanViewCustomers)
        {
            totalCustomer = await CustomersAppService.GetTotalCustomerCountAsync();
            var allCustomers = await CustomersAppService.GetListAllAsync();
            var now = DateTime.Now;
            newCustomersThisMonth = allCustomers
                .Count(c => c.CreationTime.Month == now.Month && c.CreationTime.Year == now.Year);
        }

        totalSuccessRate = await ProjectAppService.GetSuccessRateAverageAsync(null);
        var allTasks = await TasksAppService.GetListAllAsync();
        activeTasks = allTasks.Count(t => t.Status == EnumStatus.Active);

        employeeMonthlyTasks = await EmployeeAppService.GetMonthlyAssignedTaskCountsAsync();

    }

    private int newCustomersThisMonth;  
    private int activeTasks;    

    private string GetCurrentUserFullName()
    {
        var authState = AuthenticationStateProvider.GetAuthenticationStateAsync().Result;
        var user = authState.User;

        var name = user.FindFirst("given_name")?.Value;
        var surname = user.FindFirst("family_name")?.Value;

        if (string.IsNullOrWhiteSpace(name) || string.IsNullOrWhiteSpace(surname))
        {
            return "Guest";
        }

        return $"{name} {surname}";
    }
}


<style>
    .project-overview {
        display: flex;
        justify-content: space-between;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        margin-top: 20px;
    }

    .card-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }

    .left-card, .right-card {
        flex: 1;
    }
    .overview-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .overview-item .icon {
            font-size: 24px;
            color: #6c757d;
        }

    .top-label {
        font-size: 14px;
        color: #6c757d;
        margin-bottom: 5px;
    }

    .field-label {
        font-size: 18px;
        color: #000;
        font-weight: 500;
    }

    .welcome-mesaage {
        font-size: 16px;
        font: bold;
        color: black;
    }

    .scroll-table {
        max-height: 220px; 
        overflow-y: auto;
        border: 1px solid #e9ecef;
        border-radius: 6px;
    }

    .table-sm td,
    .table-sm th {
        padding: 0.35rem;
        font-size: 13px;
    }


</style>
