@page "/customers/detail/{Id:guid}"

@using Crm.Customers
@using Crm.CustomerNotes
@using Crm.Activities

@inject ICustomerAppService CustomerAppService
@inject ICustomerNoteAppService CustomerNoteAppService
@inject IActivityAppService ActivityAppService
@inject NavigationManager Navigation
@inject Microsoft.Extensions.Localization.IStringLocalizer<Crm.Localization.CrmResource> L

<Div class="mt-4">
    <Card Class="shadow-lg">
        <CardHeader>
            <Div class="d-flex align-items-center">
                <i class="fa-solid fa-user text-primary fa-2x me-2"></i>
                <h4 class="m-0">@L["Customer Detail"]</h4>
            </Div>
        </CardHeader>

        <CardBody>

            @if (customer == null)
            {
                <Div class="text-center py-4">
                    <spinner Color="Color.Primary" />
                    <p class="text-muted mt-2">@L["Loading customer information"]...</p>
                </Div>
            }
            else
            {
                <!-- ================= PERSONAL & COMPANY INFO ================= -->
                <Row>
                    <Column ColumnSize="ColumnSize.Is6.OnDesktop">
                        <Card Class="mb-3 border">
                            <CardBody>
                                <h5 class="mb-3">
                                    <i class="fa-solid fa-id-card-clip text-primary me-2"></i>
                                    @L["Personal Infos"]
                                </h5>

                                <p><Strong>@L["Name"]:</Strong> @customer.Name</p>
                                <p><Strong>@L["Surname"]:</Strong> @customer.Surname</p>
                                <p><Strong>@L["Email"]:</Strong> @customer.Email</p>
                                <p><Strong>@L["Phone"]:</Strong> @customer.Phone</p>
                                <p>
                                    <Strong>@L["Customer Type"]:</Strong>

                                    @{
                                        var type = customer.CustomerType;
                                        var badgeClass = type switch
                                        {
                                            EnumCustomer.Lead => "badge bg-secondary",
                                            EnumCustomer.Prospect => "badge bg-info",
                                            EnumCustomer.ProposalStage => "badge bg-warning text-dark",
                                            EnumCustomer.Won => "badge bg-success",
                                            EnumCustomer.Lost => "badge bg-danger",
                                            EnumCustomer.ActiveProjectCustomer => "badge bg-primary",
                                            _ => "badge bg-light text-dark"
                                        };
                                    }

                                    <span class="@badgeClass">@type</span>
                                </p>

                            </CardBody>
                        </Card>
                    </Column>

                    <Column ColumnSize="ColumnSize.Is6.OnDesktop">
                        <Card class="mb-3 border">
                            <CardBody>
                                <h5 class="mb-3">
                                    <i class="fa-solid fa-building text-primary me-2"></i>
                                    @L["Company Info"]
                                </h5>

                                <p><Strong>@L["Company Name"]:</Strong> @customer.CompanyName</p>
                                <p><Strong>@L["Address"]:</Strong> @customer.Address</p>
                                <p><Strong>@L["Created At"]:</Strong> @customer.CreationTime.ToString("dd MMM yyyy HH:mm")</p>

                            </CardBody>
                        </Card>
                    </Column>
                </Row>

                <!-- ================= CUSTOMER NOTES ================= -->
                <Card class="border mt-4">
                    <CardHeader>
                        <h5 class="m-0">
                            <i class="fa-solid fa-note-sticky text-warning me-2"></i>
                            @L["Customer Notes"]
                        </h5>
                    </CardHeader>

                    <CardBody>
                        @if (notes == null)
                        {
                            <spinner Color="Color.Warning" />
                        }
                        else if (!notes.Any())
                        {
                            <p class="text-muted">@L["No notes found for this customer"].</p>
                        }
                        else
                        {
                            <ListGroup>
                                @foreach (var note in notes)
                                {
                                    <ListGroupItem>
                                        <p class="mb-1">@note.Note</p>
                                        <small class="text-muted">
                                            <i class="fa-regular fa-clock me-1"></i>
                                            @note.NoteDate.ToString("dd MMM yyyy HH:mm")
                                        </small>
                                    </ListGroupItem>
                                }
                            </ListGroup>
                        }
                    </CardBody>
                </Card>

                <!-- ================= ACTIVITIES ================= -->
                 <Card class="border mt-4">
                    <CardHeader>
                        <h5 class="m-0">
                            <i class="fa-solid fa-list-check text-info me-2"></i>
                            @L["Customer Activities"]
                        </h5>
                    </CardHeader>

                    <CardBody>
                        @if (activities == null)
                        {
                            <spinner Color="Color.Info" />
                        }
                        else if (!activities.Any())
                        {
                            <p class="text-muted">@L["No activities recorded for this customer"].</p>
                        }
                        else
                        {
                            <Table Hoverable Striped>
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Description</th>
                                        <th>Date</th>
                                        <th>Employee</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var act in activities)
                                {
                                    <tr>
                                    <td>@act.Type.ToString()</td>
                                    <td>@act.Description</td>
                                    <td>@act.Date.ToString("dd MMM yyyy HH:mm")</td>
                                    <td>@act.EmployeeName @act.EmployeeSurname</td>

                                    </tr>
                                }

                                </tbody>
                            </Table>
                        }
                    </CardBody>
                </Card> 

                <Div class="text-end mt-3">                   

                    <Button Color="Color.Primary" Clicked="@DownloadPdf">
                        <i class="fa-solid fa-file-pdf me-1"></i> @L["Download PDF"]
                    </Button>

                </Div>
            }
        </CardBody>
    </Card>
</Div>