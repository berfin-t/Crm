@page "/tasks"
@using Crm.Blazor.Components.Dialogs.Tasks
@using Crm.Common
@using Crm.Tasks
@inject ITaskAppService TaskAppService

@if (items != null && items.Any())
{
    <DropContainer TItem="TaskDto"
                   Items="@items"
                   ItemsFilter="@((item, dropZone) => item.Group == dropZone)"
                   ItemDropped="@ItemDropped"
                   Flex="Flex.Wrap.Grow.Is1"
                   class="flex justify-between gap-4 w-full">                    
                  

        <ChildContent>
             @foreach (var zone in new[] { "Active", "Pending", "Completed" })
            {
                var zoneStyle = zone switch
                {
                    "Active" => "background-color:#D1FAE5; border:2px solid #34D399;",     // yeşil
                    "Pending" => "background-color:#FEF3C7; border:2px solid #FBBF24;",    // sarı
                    "Completed" => "background-color:#FEE2E2; border:2px solid #EF4444;",  // kırmızı
                    _ => "background-color:#F3F4F6; border:2px solid #D1D5DB;"
                };

                <DropZone TItem="TaskDto"
                          Name="@zone"
                          style="@zoneStyle"
                          class="flex-1 min-w-[200px] max-w-xs rounded-lg p-3 m-3">
                    
                    <ChildContent>
                        <Heading Size="HeadingSize.Is4"
                                 Margin="Margin.Is3.FromBottom"
                                 class="overflow-hidden text-ellipsis">
                            @zone
                        </Heading>
                    </ChildContent>

                    <ItemTemplate Context="task">
                        <Card Shadow="Shadow.Default"
                              Margin="Margin.Is3.OnY"
                              @onclick="() => OnCardClick(task)"
                              style="@GetPriorityBorderStyle(task)"
                              class="overflow-hidden whitespace-nowrap text-ellipsis transition-transform transform hover:scale-105 cursor-pointer">
                            <CardBody class="overflow-hidden text-ellipsis">
                                @(task.Name!.Length > 25 ? task.Name.Substring(0, 25) + "..." : task.Name)
                            </CardBody>
                        </Card>
                    </ItemTemplate>


                </DropZone>
            }
        </ChildContent>

    </DropContainer>
}

<TaskDetailModal @ref="taskDetailModal" Task="@selectedTask" />

@code {
    private List<TaskDto> items = new List<TaskDto>{};
    private TaskDto? selectedTask;
    private TaskDetailModal? taskDetailModal;
    [Parameter] public TaskDto? TaskPriority { get; set; }

    protected override async System.Threading.Tasks.Task OnInitializedAsync()
    {
        items = (await TaskAppService.GetListAllAsync()).OrderByDescending(x=>x.Priority).ToList();
        StateHasChanged();
    }

    private async System.Threading.Tasks.Task ItemDropped(DraggableDroppedEventArgs<TaskDto> dropItem)
    {
        dropItem.Item.Group = dropItem.DropZoneName;
        var updateDto = new TaskUpdateDto
        {
            Name = dropItem.Item.Name!,
            Description = dropItem.Item.Description!,
            DueDate = dropItem.Item.DueDate,
            Priority = dropItem.Item.Priority,
            Group = dropItem.DropZoneName,
            ProjectId = dropItem.Item.ProjectId,
            EmployeeId = dropItem.Item.EmployeeId,
            Status = MapStatus(dropItem.DropZoneName)
        };
        await TaskAppService.UpdateAsync(dropItem.Item.Id, updateDto);
        items = (await TaskAppService.GetListAllAsync()).OrderByDescending(x=>x.Priority).ToList();
        StateHasChanged();
        return; 
    }
    
    private void OnCardClick(TaskDto task)
    {
        selectedTask = task;
        taskDetailModal?.Show();  
    }   

    private string GetPriorityBorderStyle(TaskDto task)
    {
        if (task == null)
            return "border-left: 5px solid #D1D5DB; background-color: #FFFFFF;"; 

        return task.Priority switch
        {
            EnumPriority.Low => "border-left: 5px solid #22C55E; background-color: #FFFFFF;",      // Yeşil
            EnumPriority.Medium => "border-left: 5px solid #FACC15; background-color: #FFFFFF;",   // Sarı
            EnumPriority.High => "border-left: 5px solid #F97316; background-color: #FFFFFF;",     // Turuncu
            EnumPriority.Critical => "border-left: 5px solid #EF4444; background-color: #FFFFFF;", // Kırmızı
            _ => "border-left: 5px solid #D1D5DB; background-color: #FFFFFF;"
        };
    }

    private EnumStatus MapStatus(string zone)
    {
        return zone switch
        {
            "Pending" => EnumStatus.Pending,
            "Active" => EnumStatus.Active,
            "Completed" => EnumStatus.Completed,
            _ => EnumStatus.Pending
        };
    }


}
